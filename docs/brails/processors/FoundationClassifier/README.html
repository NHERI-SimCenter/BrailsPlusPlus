

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Raised Foundation Classification &mdash; BRAILS++  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=f281be69"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            BRAILS++
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../rst-doc/about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rst-doc/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rst-code/brails.html">brails package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rst-doc/acknowledgements.html">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rst-doc/license.html">Copyright and License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rst-doc/cite.html">How to Cite</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">BRAILS++</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Raised Foundation Classification</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/brails/processors/FoundationClassifier/README.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="raised-foundation-classification">
<h1>Raised Foundation Classification<a class="headerlink" href="#raised-foundation-classification" title="Link to this heading"></a></h1>
<section id="what-is-raised-foundation-classification">
<h2>What is Raised Foundation Classification<a class="headerlink" href="#what-is-raised-foundation-classification" title="Link to this heading"></a></h2>
<p>The code in this package enables to see if a building is on piles piers or posts (PPP). For classification, the path of a folder holding the images has to be supplied. The result will be a comma separated value file in that folder, listing the filenames and classification result.</p>
<p>There is further optional code to improve the quality and speed of the classification. At the current moment, classification reaches an F1-score of 72% on a random test set, holding out 20% of the data.</p>
<section id="copyright">
<h3>Copyright<a class="headerlink" href="#copyright" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Copyright</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="mi">2018</span><span class="p">,</span> <span class="n">The</span> <span class="n">Regents</span> <span class="n">of</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">California</span>
<span class="n">Contact</span><span class="p">:</span> <span class="n">Sascha</span> <span class="n">Hornauer</span>  <span class="o">-</span> <span class="n">sascha</span><span class="o">.</span><span class="n">hornauer</span><span class="nd">@uni</span><span class="o">-</span><span class="n">oldenburg</span><span class="o">.</span><span class="n">de</span>
</pre></div>
</div>
</section>
<section id="bsd-3-caluse-license">
<h3>BSD 3-Caluse license<a class="headerlink" href="#bsd-3-caluse-license" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Redistribution</span> <span class="ow">and</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">source</span> <span class="ow">and</span> <span class="n">binary</span> <span class="n">forms</span><span class="p">,</span> <span class="k">with</span> <span class="ow">or</span> <span class="n">without</span>
<span class="n">modification</span><span class="p">,</span> <span class="n">are</span> <span class="n">permitted</span> <span class="n">provided</span> <span class="n">that</span> <span class="n">the</span> <span class="n">following</span> <span class="n">conditions</span> <span class="n">are</span> <span class="n">met</span><span class="p">:</span>

<span class="o">*</span> <span class="n">Redistributions</span> <span class="n">of</span> <span class="n">source</span> <span class="n">code</span> <span class="n">must</span> <span class="n">retain</span> <span class="n">the</span> <span class="n">above</span> <span class="n">copyright</span> <span class="n">notice</span><span class="p">,</span> <span class="n">this</span>
  <span class="nb">list</span> <span class="n">of</span> <span class="n">conditions</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">following</span> <span class="n">disclaimer</span><span class="o">.</span>

<span class="o">*</span> <span class="n">Redistributions</span> <span class="ow">in</span> <span class="n">binary</span> <span class="n">form</span> <span class="n">must</span> <span class="n">reproduce</span> <span class="n">the</span> <span class="n">above</span> <span class="n">copyright</span> <span class="n">notice</span><span class="p">,</span>
  <span class="n">this</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">conditions</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">following</span> <span class="n">disclaimer</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">documentation</span>
  <span class="ow">and</span><span class="o">/</span><span class="ow">or</span> <span class="n">other</span> <span class="n">materials</span> <span class="n">provided</span> <span class="k">with</span> <span class="n">the</span> <span class="n">distribution</span><span class="o">.</span>

<span class="o">*</span> <span class="n">Neither</span> <span class="n">the</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">copyright</span> <span class="n">holder</span> <span class="n">nor</span> <span class="n">the</span> <span class="n">names</span> <span class="n">of</span> <span class="n">its</span>
  <span class="n">contributors</span> <span class="n">may</span> <span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="n">endorse</span> <span class="ow">or</span> <span class="n">promote</span> <span class="n">products</span> <span class="n">derived</span> <span class="kn">from</span>
  <span class="nn">this</span> <span class="n">software</span> <span class="n">without</span> <span class="n">specific</span> <span class="n">prior</span> <span class="n">written</span> <span class="n">permission</span><span class="o">.</span>

<span class="n">THIS</span> <span class="n">SOFTWARE</span> <span class="n">IS</span> <span class="n">PROVIDED</span> <span class="n">BY</span> <span class="n">THE</span> <span class="n">COPYRIGHT</span> <span class="n">HOLDERS</span> <span class="n">AND</span> <span class="n">CONTRIBUTORS</span> <span class="s2">&quot;AS IS&quot;</span>
<span class="n">AND</span> <span class="n">ANY</span> <span class="n">EXPRESS</span> <span class="n">OR</span> <span class="n">IMPLIED</span> <span class="n">WARRANTIES</span><span class="p">,</span> <span class="n">INCLUDING</span><span class="p">,</span> <span class="n">BUT</span> <span class="n">NOT</span> <span class="n">LIMITED</span> <span class="n">TO</span><span class="p">,</span> <span class="n">THE</span>
<span class="n">IMPLIED</span> <span class="n">WARRANTIES</span> <span class="n">OF</span> <span class="n">MERCHANTABILITY</span> <span class="n">AND</span> <span class="n">FITNESS</span> <span class="n">FOR</span> <span class="n">A</span> <span class="n">PARTICULAR</span> <span class="n">PURPOSE</span> <span class="n">ARE</span>
<span class="n">DISCLAIMED</span><span class="o">.</span> <span class="n">IN</span> <span class="n">NO</span> <span class="n">EVENT</span> <span class="n">SHALL</span> <span class="n">THE</span> <span class="n">COPYRIGHT</span> <span class="n">HOLDER</span> <span class="n">OR</span> <span class="n">CONTRIBUTORS</span> <span class="n">BE</span> <span class="n">LIABLE</span>
<span class="n">FOR</span> <span class="n">ANY</span> <span class="n">DIRECT</span><span class="p">,</span> <span class="n">INDIRECT</span><span class="p">,</span> <span class="n">INCIDENTAL</span><span class="p">,</span> <span class="n">SPECIAL</span><span class="p">,</span> <span class="n">EXEMPLARY</span><span class="p">,</span> <span class="n">OR</span> <span class="n">CONSEQUENTIAL</span>
<span class="n">DAMAGES</span> <span class="p">(</span><span class="n">INCLUDING</span><span class="p">,</span> <span class="n">BUT</span> <span class="n">NOT</span> <span class="n">LIMITED</span> <span class="n">TO</span><span class="p">,</span> <span class="n">PROCUREMENT</span> <span class="n">OF</span> <span class="n">SUBSTITUTE</span> <span class="n">GOODS</span> <span class="n">OR</span>
<span class="n">SERVICES</span><span class="p">;</span> <span class="n">LOSS</span> <span class="n">OF</span> <span class="n">USE</span><span class="p">,</span> <span class="n">DATA</span><span class="p">,</span> <span class="n">OR</span> <span class="n">PROFITS</span><span class="p">;</span> <span class="n">OR</span> <span class="n">BUSINESS</span> <span class="n">INTERRUPTION</span><span class="p">)</span> <span class="n">HOWEVER</span>
<span class="n">CAUSED</span> <span class="n">AND</span> <span class="n">ON</span> <span class="n">ANY</span> <span class="n">THEORY</span> <span class="n">OF</span> <span class="n">LIABILITY</span><span class="p">,</span> <span class="n">WHETHER</span> <span class="n">IN</span> <span class="n">CONTRACT</span><span class="p">,</span> <span class="n">STRICT</span> <span class="n">LIABILITY</span><span class="p">,</span>
<span class="n">OR</span> <span class="n">TORT</span> <span class="p">(</span><span class="n">INCLUDING</span> <span class="n">NEGLIGENCE</span> <span class="n">OR</span> <span class="n">OTHERWISE</span><span class="p">)</span> <span class="n">ARISING</span> <span class="n">IN</span> <span class="n">ANY</span> <span class="n">WAY</span> <span class="n">OUT</span> <span class="n">OF</span> <span class="n">THE</span> <span class="n">USE</span>
<span class="n">OF</span> <span class="n">THIS</span> <span class="n">SOFTWARE</span><span class="p">,</span> <span class="n">EVEN</span> <span class="n">IF</span> <span class="n">ADVISED</span> <span class="n">OF</span> <span class="n">THE</span> <span class="n">POSSIBILITY</span> <span class="n">OF</span> <span class="n">SUCH</span> <span class="n">DAMAGE</span><span class="o">.</span>
</pre></div>
</div>
</section>
</section>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Link to this heading"></a></h2>
<p>The following commands clone the BRAILS repository and enter the foundation classification module.
Requirements are installed using pip. The final
command adds the current folder to the PYTHONPATH environment variable which is necessary to train.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/NHERI-SimCenter/BRAILS.git BRAILS
cd BRAILS/brails/modules/Foundation_Classification
python3 -m pip install -r requirements.txt
export PYTHONPATH=$PYTHONPATH:`pwd`
</pre></div>
</div>
</section>
<section id="how-to-use">
<h2>How to use<a class="headerlink" href="#how-to-use" title="Link to this heading"></a></h2>
<section id="execute-with-pretrained-model">
<h3>Execute with pretrained model<a class="headerlink" href="#execute-with-pretrained-model" title="Link to this heading"></a></h3>
<p>The detect code will download approximately 300 mb in required model weight files on its first start.
Detection on a single image or all images in a folder is started in the same way. The default classifier
with the provided checkpoint expects as input, given with –image-path, either a single image or
a folder which will be searched for images. One way of improving detection is to mask the parts
of the image which are not a building. That is done with –mask-buildings.
Please see <cite>Pre-Saving Masked Images</cite> about how to create masks. If masks should not be used remove the
–mask-buildings flag from the command line.
If masks should be generated on the fly remove the –load-masks flag, however this will
take more time and use more GPU memory.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="n">detect</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">image</span><span class="o">-</span><span class="n">path</span> <span class="o">&lt;</span><span class="n">IMG_FOLDER</span> <span class="ow">or</span> <span class="n">IMAGE</span> <span class="n">PATH</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">mask</span><span class="o">-</span><span class="n">buildings</span> <span class="o">--</span><span class="n">load</span><span class="o">-</span><span class="n">masks</span>
</pre></div>
</div>
<p>The result will be a comma separated value file <em>&lt;IMG_FOLDER&gt;_prediction_results.csv</em> which contains in each row a filename for each image and a 1 if the building is higher than 8ft or 0 otherwise.</p>
</section>
</section>
<section id="optional-improvements">
<h2>Optional Improvements<a class="headerlink" href="#optional-improvements" title="Link to this heading"></a></h2>
<section id="pre-saving-masked-images">
<h3>Pre-Saving Masked Images<a class="headerlink" href="#pre-saving-masked-images" title="Link to this heading"></a></h3>
<p>One step of the detection is masking out the background from the buildings.
This step can take up some time so for re-training of the model, it is suggested
to pre-compute the masks with this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="n">save_masked_images</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">image</span><span class="o">-</span><span class="n">path</span> <span class="o">&lt;</span><span class="n">IMG_FOLDER</span> <span class="ow">or</span> <span class="n">IMAGE</span> <span class="n">PATH</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Masks of images will be saved and expected at the same folder as the original images.</p>
</section>
<section id="input-data-format-for-training">
<h3>Input Data Format for Training<a class="headerlink" href="#input-data-format-for-training" title="Link to this heading"></a></h3>
<p>Training, validation and test folders should be separate. The name is arbitrary and each path can
be stated separately with command line parameters during training. Within each folder there
has to be one folder for each label, named <em>ppp_buildings</em>, containing images of buildings from the PPP category
and other containing buildings which are not in that category. The same structure holds for the val and test folders.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>IMG_FOLDER
├── train
│   └── ppp_buildings
│       ├── image_00x.jpg
│       └── image_00x-mask.png
│   └── other
│       ├── image_00x.jpg
│       └── image_00x-mask.png
├── val
│   └── &lt;structure identical to train&gt;
└── test
    └── &lt;structure identical to train&gt;
</pre></div>
</div>
<p>For training it is necessary to create the masks beforehand, as described in the previous section.</p>
</section>
<section id="cleaning-the-dataset">
<h3>Cleaning the Dataset<a class="headerlink" href="#cleaning-the-dataset" title="Link to this heading"></a></h3>
<p>Many datasets have outliers which do not show buildings but empty properties or
objects covering the camera. A half-automatic way of finding and removing noisy images from the
dataset is described in the following</p>
</section>
<section id="training-the-model">
<h3>Training the Model<a class="headerlink" href="#training-the-model" title="Link to this heading"></a></h3>
<p>Training can happen in two different ways: With an attention based
network or with a standard Resnet 50, with or without unsupervised pretraining.</p>
</section>
<section id="unsupervised-pretraining">
<h3>Unsupervised Pretraining<a class="headerlink" href="#unsupervised-pretraining" title="Link to this heading"></a></h3>
<p>The network used for foundation classification can be pre-trained on a different task to improve
the results. Because of the unsupervised nature of this pre-training the whole dataset can be used,
including validation and test data. It is also possible to set different sub-sets with the
command line preferences. This step will produce a checkpoint which can be loaded for later
foundation detection, called in the following &lt;NPID CHECKPOINT&gt;.</p>
<p>The most important command line parameters are:</p>
<pre class="literal-block">--train-data, --val-data for setting the folders in which images are kept for training and validation.
Validation here is a kNN step which will judge the quality of the feature embedding of the network. The
reported performance is correlated with the foundation detection performance but not the same

--resume Optionally, a checkpoint can be loaded which was pretrained on ImageNet to further improve training. The same
parameter is used if training is interrupted and should be continued

--name Logfiles and checkpoints will be created with this name as prefix.

--mask-buildings Masks are used to mask out buildings. See <a class="reference internal" href="#pre-saving-masked-images">Pre-Saving Masked Images</a> for how to create masks from images.

--epochs How many epochs should be trained.

--low-dim The embedded dimension of the approach. This is a hyperparameter which can be
optimized. For most purposes the default of 128 will suffice. Smaller values can be
chosen for datasets, significantly smaller than 1000 training images.</pre>
<p>Further parameters can be seen by just parsing the -h parameter. The command to train 100 epochs is therefore:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="n">npid</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">py</span>
    <span class="o">--</span><span class="n">train</span><span class="o">-</span><span class="n">data</span> <span class="o">&lt;</span><span class="n">TRAINING</span> <span class="n">IMAGE</span> <span class="n">FOLDER</span><span class="o">&gt;</span>
    <span class="o">--</span><span class="n">val</span><span class="o">-</span><span class="n">data</span> <span class="o">&lt;</span><span class="n">VALIDATION</span> <span class="n">IMAGE</span> <span class="n">FOLDER</span><span class="o">&gt;</span>
    <span class="o">--</span><span class="n">resume</span> <span class="o">&lt;</span><span class="n">CHECKPOINT</span> <span class="n">TO</span> <span class="n">LOAD</span><span class="o">&gt;</span>
    <span class="o">--</span><span class="n">name</span> <span class="o">&lt;</span><span class="n">NAME</span> <span class="n">FOR</span> <span class="n">LOGFILES</span> <span class="n">AND</span> <span class="n">CHECKPOINTS</span><span class="o">&gt;</span>
    <span class="o">--</span><span class="n">mask</span><span class="o">-</span><span class="n">buildings</span>
    <span class="o">--</span><span class="n">epochs</span> <span class="mi">100</span>
</pre></div>
</div>
<p>During training two checkpoints will be saved in the same folder, one which is always the checkpoint of the
latest epoch and one which is the best, according to the internal quality measure.</p>
</section>
<section id="foundation-classification-model-training">
<h3>Foundation Classification Model Training<a class="headerlink" href="#foundation-classification-model-training" title="Link to this heading"></a></h3>
<p>The model can be trained on existing data. The folder structure shown in <a class="reference internal" href="#input-data-format-for-training">Input Data Format for Training</a>
has to be observed so the right labels are assigned. The most important command line parameters are:</p>
<pre class="literal-block">--epochs Amount of epochs to train

--train-data, --val-data, --test-data for setting the folders in which images are kept for training and validation.
These folders should contain separate data. --test-data is only needed in combination with the --eval flag to
check the performance on the test data.

--eval Evaluate the trained model on the test set. A model should be loaded with the --checkpoint flag.

--checkpoint Load a checkpoint to continue training or evaluate the performance on the test set.

--mask-buildings Mask the buildings. Warning: Prior masking is mandatory. On the fly generation does not work for training.
See <a class="reference internal" href="#pre-saving-masked-images">Pre-Saving Masked Images</a> for how to create masks from images.

--freeze-layers When loading from a checkpoint, all layers apart from the final fully connected layer can be frozen
for finetuning.

--pretrained Removes saved classifier weights from a checkpoint and uses the remaining for pretraining. Load the checkpoint via --checkpoint

--exp-name  Prefix for logfiles and checkpoints</pre>
<p>Further parameters can be seen by just parsing the -h parameter. The command to train 100 epochs is therefore:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="n">train</span><span class="o">.</span><span class="n">py</span>
    <span class="o">--</span><span class="n">train</span><span class="o">-</span><span class="n">data</span> <span class="o">&lt;</span><span class="n">TRAINING</span> <span class="n">IMAGE</span> <span class="n">FOLDER</span><span class="o">&gt;</span>
    <span class="o">--</span><span class="n">val</span><span class="o">-</span><span class="n">data</span> <span class="o">&lt;</span><span class="n">VALIDATION</span> <span class="n">IMAGE</span> <span class="n">FOLDER</span><span class="o">&gt;</span>
    <span class="o">--</span><span class="n">exp</span><span class="o">-</span><span class="n">name</span> <span class="o">&lt;</span><span class="n">NAME</span> <span class="n">FOR</span> <span class="n">LOGFILES</span> <span class="n">AND</span> <span class="n">CHECKPOINTS</span><span class="o">&gt;</span>
    <span class="o">--</span><span class="n">mask</span><span class="o">-</span><span class="n">buildings</span>
    <span class="o">--</span><span class="n">epochs</span> <span class="mi">100</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, fmk.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>